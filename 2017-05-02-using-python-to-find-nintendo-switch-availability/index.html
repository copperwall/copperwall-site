<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><style data-href="/styles.b06b2600d709496d733b.css">a{text-decoration:none}</style><meta name="generator" content="Gatsby 2.1.4"/><style id="typography.js">html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}body{margin:0}article,aside,details,figcaption,figure,footer,header,main,menu,nav,section,summary{display:block}audio,canvas,progress,video{display:inline-block}audio:not([controls]){display:none;height:0}progress{vertical-align:baseline}[hidden],template{display:none}a{background-color:transparent;-webkit-text-decoration-skip:objects}a:active,a:hover{outline-width:0}abbr[title]{border-bottom:none;text-decoration:underline;text-decoration:underline dotted}b,strong{font-weight:inherit;font-weight:bolder}dfn{font-style:italic}h1{font-size:2em;margin:.67em 0}mark{background-color:#ff0;color:#000}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}img{border-style:none}svg:not(:root){overflow:hidden}code,kbd,pre,samp{font-family:monospace,monospace;font-size:1em}figure{margin:1em 40px}hr{box-sizing:content-box;height:0;overflow:visible}button,input,optgroup,select,textarea{font:inherit;margin:0}optgroup{font-weight:700}button,input{overflow:visible}button,select{text-transform:none}[type=reset],[type=submit],button,html [type=button]{-webkit-appearance:button}[type=button]::-moz-focus-inner,[type=reset]::-moz-focus-inner,[type=submit]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,[type=reset]:-moz-focusring,[type=submit]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal}textarea{overflow:auto}[type=checkbox],[type=radio]{box-sizing:border-box;padding:0}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}[type=search]::-webkit-search-cancel-button,[type=search]::-webkit-search-decoration{-webkit-appearance:none}::-webkit-input-placeholder{color:inherit;opacity:.54}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}html{font:100%/1.625 -apple-system,'BlinkMacSystemFont','Segoe UI','Roboto','Helvetica','Arial',sans-serif,'Apple Color Emoji','Segoe UI Emoji','Segoe UI Symbol';box-sizing:border-box;overflow-y:scroll;}*{box-sizing:inherit;}*:before{box-sizing:inherit;}*:after{box-sizing:inherit;}body{color:hsla(0,0%,0%,0.8);font-family:-apple-system,'BlinkMacSystemFont','Segoe UI','Roboto','Helvetica','Arial',sans-serif,'Apple Color Emoji','Segoe UI Emoji','Segoe UI Symbol';font-weight:normal;word-wrap:break-word;font-kerning:normal;-moz-font-feature-settings:"kern", "liga", "clig", "calt";-ms-font-feature-settings:"kern", "liga", "clig", "calt";-webkit-font-feature-settings:"kern", "liga", "clig", "calt";font-feature-settings:"kern", "liga", "clig", "calt";}img{max-width:100%;margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8125rem;}h1{margin-left:0;margin-right:0;margin-top:2.4375rem;padding-bottom:calc(0.40625rem - 1px);padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.21875rem;color:inherit;font-family:-apple-system,'BlinkMacSystemFont','Segoe UI','Roboto','Helvetica','Arial',sans-serif,'Apple Color Emoji','Segoe UI Emoji','Segoe UI Symbol';font-weight:600;text-rendering:optimizeLegibility;font-size:2rem;line-height:1.1;border-bottom:1px solid hsla(0,0%,0%,0.07);}h2{margin-left:0;margin-right:0;margin-top:1.625rem;padding-bottom:calc(0.40625rem - 1px);padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.40625rem;color:inherit;font-family:-apple-system,'BlinkMacSystemFont','Segoe UI','Roboto','Helvetica','Arial',sans-serif,'Apple Color Emoji','Segoe UI Emoji','Segoe UI Symbol';font-weight:600;text-rendering:optimizeLegibility;font-size:1.51572rem;line-height:1.1;border-bottom:1px solid hsla(0,0%,0%,0.07);}h3{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8125rem;color:inherit;font-family:-apple-system,'BlinkMacSystemFont','Segoe UI','Roboto','Helvetica','Arial',sans-serif,'Apple Color Emoji','Segoe UI Emoji','Segoe UI Symbol';font-weight:600;text-rendering:optimizeLegibility;font-size:1.31951rem;line-height:1.1;}h4{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8125rem;color:inherit;font-family:-apple-system,'BlinkMacSystemFont','Segoe UI','Roboto','Helvetica','Arial',sans-serif,'Apple Color Emoji','Segoe UI Emoji','Segoe UI Symbol';font-weight:600;text-rendering:optimizeLegibility;font-size:1rem;line-height:1.1;}h5{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8125rem;color:inherit;font-family:-apple-system,'BlinkMacSystemFont','Segoe UI','Roboto','Helvetica','Arial',sans-serif,'Apple Color Emoji','Segoe UI Emoji','Segoe UI Symbol';font-weight:600;text-rendering:optimizeLegibility;font-size:0.87055rem;line-height:1.1;}h6{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8125rem;color:hsla(0,0%,0%,0.53);font-family:-apple-system,'BlinkMacSystemFont','Segoe UI','Roboto','Helvetica','Arial',sans-serif,'Apple Color Emoji','Segoe UI Emoji','Segoe UI Symbol';font-weight:600;text-rendering:optimizeLegibility;font-size:0.81225rem;line-height:1.1;}hgroup{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8125rem;}ul{margin-left:1.625rem;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8125rem;list-style-position:outside;list-style-image:none;}ol{margin-left:1.625rem;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8125rem;list-style-position:outside;list-style-image:none;}dl{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8125rem;}dd{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8125rem;}p{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8125rem;}figure{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8125rem;}pre{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8125rem;font-size:0.85rem;line-height:1.625rem;}table{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8125rem;font-size:1rem;line-height:1.625rem;border-collapse:collapse;width:100%;}fieldset{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8125rem;}blockquote{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:calc(0.8125rem - 1px);padding-right:0;padding-top:0;margin-bottom:0.8125rem;border-left:4px solid hsla(0,0%,0%,0.13);color:hsla(0,0%,0%,0.53);}form{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8125rem;}noscript{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8125rem;}iframe{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8125rem;}hr{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:calc(0.8125rem - 1px);background:hsla(0,0%,0%,0.2);border:none;height:1px;}address{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8125rem;}b{font-weight:600;}strong{font-weight:600;}dt{font-weight:600;}th{font-weight:600;}li{margin-bottom:calc(0.8125rem / 2);}ol li{padding-left:0;}ul li{padding-left:0;}li > ol{margin-left:1.625rem;margin-bottom:calc(0.8125rem / 2);margin-top:calc(0.8125rem / 2);}li > ul{margin-left:1.625rem;margin-bottom:calc(0.8125rem / 2);margin-top:calc(0.8125rem / 2);}blockquote *:last-child{margin-bottom:0;}li *:last-child{margin-bottom:0;}p *:last-child{margin-bottom:0;}li > p{margin-bottom:calc(0.8125rem / 2);}code{font-size:0.85rem;line-height:1.625rem;}kbd{font-size:0.85rem;line-height:1.625rem;}samp{font-size:0.85rem;line-height:1.625rem;}abbr{border-bottom:1px dotted hsla(0,0%,0%,0.5);cursor:help;}acronym{border-bottom:1px dotted hsla(0,0%,0%,0.5);cursor:help;}abbr[title]{border-bottom:1px dotted hsla(0,0%,0%,0.5);cursor:help;text-decoration:none;}thead{text-align:left;}td,th{text-align:left;border-bottom:1px solid hsla(0,0%,0%,0.12);font-feature-settings:"tnum";-moz-font-feature-settings:"tnum";-ms-font-feature-settings:"tnum";-webkit-font-feature-settings:"tnum";padding-left:1.08333rem;padding-right:1.08333rem;padding-top:0.8125rem;padding-bottom:calc(0.8125rem - 1px);}th:first-child,td:first-child{padding-left:0;}th:last-child,td:last-child{padding-right:0;}h3,h4,h5,h6{margin-bottom:0.8125rem;margin-top:1.625rem;}ol,ul{margin-left:2.03125rem;}li>ol,li>ul{margin-left:2.03125rem;}a{color:#4078c0;text-decoration:none;}a:hover,a:active{text-decoration:underline;}</style><link as="script" rel="preload" href="/component---src-templates-blog-post-js-55223bcc0ee936eb66f2.js"/><link as="script" rel="preload" href="/0-85912511608260efd9e6.js"/><link as="script" rel="preload" href="/app-122c52d0e65c3530e375.js"/><link as="script" rel="preload" href="/styles-3408986964b82850da36.js"/><link as="script" rel="preload" href="/webpack-runtime-57f31d95c48fe5528c16.js"/><link as="fetch" rel="preload" href="/static/d/256/path---2017-05-02-using-python-to-find-nintendo-switch-availability-893-b3e-OrvMwTp6ehTcIdI7bRTZXcdnEXg.json" crossorigin="use-credentials"/></head><body><noscript id="gatsby-noscript">This app works best with JavaScript enabled.</noscript><div id="___gatsby"><div style="outline:none" tabindex="-1" role="group"><style data-emotion-css="1gh2tui">.css-1gh2tui{margin:0 auto;max-width:700px;padding:3.25rem;padding-top:2.4375rem;}</style><div class="css-1gh2tui"><a href="/"><style data-emotion-css="9xo11w">.css-9xo11w{margin-bottom:3.25rem;display:inline-block;font-style:normal;}</style><h3 class="css-9xo11w">Copperwall Blog</h3></a><style data-emotion-css="146q31f">.css-146q31f{float:right;}</style><a class="css-146q31f" href="/about/">About</a><div><h1>Using Python/Pushbullet to find Nintendo Switch Availability</h1><div><p>This isn't super relevant with the increased Nintendo Switch availability, but I thought I'd document the process I used to make an automated in-stock notifier for Target. The main point about talking about this is how you can make a pretty useful tool with a couple lines of Python.</p>
<h3>Grabbing the data</h3>
<p>I started out this project expecting to have to scrape the HTML from the availability page on Target.com. Doing this would require grabbing the page using something like <code>urllib.urlopen</code> and then parsing the HTML using something like <code>lxml</code> or <code>BeautifulSoup</code> and then using a CSS selector to find the fields of interest in the document. However, if you open up the network tab and filter by XHR requests, you can see that the webpage does a request to <a href="https://api.target.com">api.target.com</a>, which returns a JSON document of which stores have stock in the area around your zipcode.</p>
<p><img src="https://devopps.me/static/network_tab.png" alt="network tab"></p>
<p>Now that we know there's a working API endpoint, we don't need to use extra modules like <code>lxml</code> or <code>BeautifulSoup</code> to parse HTML. We can parse the data using the <code>json</code> module and <code>json.loads</code>. This portion of the JSON document looks promising.</p>
<pre><code class="language-json">"locations": [
        {
          "location_id": "2759",
          "location_type": "STORE",
          "distance": "0.00",
          "store_name": "San Luis Obispo",
          "store_address": "11990 LOS OSOS VALLEY RD San Luis Obispo CA 93405",
          "formatted_store_address": "11990 LOS OSOS VALLEY RD, San Luis Obispo, CA 93405",
          "store_main_phone": "805-858-9902",
          "location_available_to_promise_quantity": 0,
          "location_available_to_release_quantity": 0,
          "inventory_type": "STORES",
          "onhand_quantity": 0,
          "location_demand_sum": 0,
          "location_soft_demand_sum": 0,
          "location_hard_demand_sum": 0,
          "location_transfer_demand_sum": 0,
          "location_supply_adjustment_sum": 0,
          "product_location_threshold_quantity": 0,
          "product_location_pickup_walkin_reserve": 200,
          "availability_status": "OUT_OF_STOCK",
          "multichannel_options": [
            "HOLD",
            "SHIPGUEST",
            "SHIPSTORE"
          ]
        },
        ...
    ]
</code></pre>
<p>We have a list named <strong>Locations</strong> that contains a <strong>store_name</strong> which is named after the city, and an <strong>availability_status</strong>, which is currently <strong>"OUT<em>OF</em>STOCK"</strong>. Hey, that's pretty good.</p>
<p>Using the information we have so far, we can write a python script that looks a little like:</p>
<pre><code class="language-python">import urllib.request
import json

class Target:
    api_url = "Target API URL goes here"
    user_agent = "Target doesn't like the default urllib User-Agent, so make you're own"

    def get_location_availability(self):
        ''' Gets the in store availability for a grey switch near your zipcode
            This takes the JSON response and loads it into a python dictionary and
            returns the relevant 'locations' field.
        '''
        req = urllib.request.Request(Target.api_url)
        req.add_header('User-Agent', Target.user_agent)

        with urllib.request.urlopen(req) as res:
            json_data = json.loads(res.read().decode('utf-8'))
            return json_data['products'][0]['locations']

    def get_available_stores(self):
        store_availabilities = self.get_location_availability()

        # Filter out stores that have an availability of "OUT_OF_STOCK"
        in_stock = list(filter(lambda store: store['availability_status'] != "OUT_OF_STOCK", store_availabilities))
        # Map the list of store statuses to a list of store name strings
        return list(map(lambda store: store['store_name'], in_stock))

if __name__ == "__main__":
    target = Target()

    # At this point stores is a list of store names that are not OUT_OF_STOCK.
    stores = target.get_available_stores()
</code></pre>
<h3>Handling Push Notifications</h3>
<p>The main utility behind this is that it notifies you in realtime, so that you don't need to take time everyday to check product availability listings. You could use email, or twilio for sms, or a slack bot, or pushbullet, or whatever push notification service you feel like. I used pushbullet because it's pretty easy.</p>
<p>To set up Pushbullet, create an account and go to <a href="https://www.pushbullet.com/#settings">https://www.pushbullet.com/#settings</a> and create an API Access Token. Using this token you can send a push notification from the Python script.</p>
<p>To install the Pushbullet, run <code>pip install pushbullet.py</code>.</p>
<p>A really simple push notification script looks like:</p>
<pre><code class="language-python">from pushbullet import Pushbullet

pb_api_key = "Your API Access Token"
pb = Pushbullet(pb_api_key)

title = "Test"
message = "hey wow"
pb.push_note(title, msg)
</code></pre>
<p>If you have Pushbullet installed on your phone, you should get a notification with the title and text sent in the example script.</p>
<p>Here's an updated version of the Target script with a new method for sending a list of store names that have a non <strong>OUT<em>OF</em>STOCK</strong> status.</p>
<pre><code class="language-python">import urllib.request
import json
from pushbullet import Pushbullet

class Target:
    api_url = "Target API URL goes here"
    user_agent = "Target doesn't like the default urllib User-Agent, so make you're own"

    def get_location_availability(self):
        ''' Gets the in store availability for a grey switch near your zipcode
            This takes the JSON response and loads it into a python dictionary and
            returns the relevant 'locations' field.
        '''
        req = urllib.request.Request(Target.api_url)
        req.add_header('User-Agent', Target.user_agent)

        with urllib.request.urlopen(req) as res:
            json_data = json.loads(res.read().decode('utf-8'))
            return json_data['products'][0]['locations']

    def get_available_stores(self):
        store_availabilities = self.get_location_availability()

        # Filter out stores that have an availability of "OUT_OF_STOCK"
        in_stock = list(filter(lambda store: store['availability_status'] != "OUT_OF_STOCK", store_availabilities))
        # Map the list of store statuses to a list of store name strings
        return list(map(lambda store: store['store_name'], in_stock))

# New Stuff
def push_notifications(stores):
    # Don't send a notification if no stores have it in stock.
    if not stores:
        return
    pb_api_key = "Your API Access Token"
    pb = Pushbullet(pb_api_key)

    title = "Switch Checker"
    msg = "Switches in stock at: " + ",".join(stores)

if __name__ == "__main__":
    target = Target()

    # At this point stores is a list of store names that are not OUT_OF_STOCK.
    stores = target.get_available_stores()
    # Send a notification with the in stock store names.
    push_notifications(stores)
</code></pre>
<p>At this point we've got a fully-functioning script! Woo.</p>
<h3>Running the script periodically</h3>
<p>So far there's nothing in the script that has it run automatically or at a certain interval. One option is to use Cron to run the script once a day in the morning.</p>
<p>To edit your <strong>crontab</strong>, type <code>crontab -e</code> on a Unix-like machine. It'll open up an editor and you can put something like</p>
<pre><code class="language-sh">0 8 * * * /path/to/your/python/script
</code></pre>
<p>That'll run the script every morning at 8AM. You can also have the python script loop forever, but sleep for a day or an hour or so between iterations. That'd look something like.</p>
<pre><code class="language-python">from time import sleep

if __name__ == "__main__":
    target = Target()

    while True:
        # At this point stores is a list of store names that are not OUT_OF_STOCK.
        stores = target.get_available_stores()
        # Send a notification with the in stock store names.
        push_notifications(stores)
        # Sleep a day
        sleep(86400)
</code></pre>
<p>Hopefully if you're still trying to get a Switch, this can help your search be a little less stressful. Thanks for reading. Also don't spam the Target API because you'll get rate-limited and it's not super nice.</p></div></div><a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-sa/4.0/88x31.png"/></a></div></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.page={"componentChunkName":"component---src-templates-blog-post-js","jsonName":"2017-05-02-using-python-to-find-nintendo-switch-availability-893","path":"/2017-05-02-using-python-to-find-nintendo-switch-availability/"};window.dataPath="256/path---2017-05-02-using-python-to-find-nintendo-switch-availability-893-b3e-OrvMwTp6ehTcIdI7bRTZXcdnEXg";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"app":["/app-122c52d0e65c3530e375.js"],"component---src-templates-blog-post-js":["/component---src-templates-blog-post-js-55223bcc0ee936eb66f2.js"],"component---src-pages-about-js":["/component---src-pages-about-js-95a78d56f5c264bba832.js"],"component---src-pages-index-js":["/component---src-pages-index-js-da2faa332dbec3f2603f.js"],"pages-manifest":["/pages-manifest-5a4bb7182421bb6c33c2.js"]};/*]]>*/</script><script src="/webpack-runtime-57f31d95c48fe5528c16.js" async=""></script><script src="/styles-3408986964b82850da36.js" async=""></script><script src="/app-122c52d0e65c3530e375.js" async=""></script><script src="/0-85912511608260efd9e6.js" async=""></script><script src="/component---src-templates-blog-post-js-55223bcc0ee936eb66f2.js" async=""></script></body></html>