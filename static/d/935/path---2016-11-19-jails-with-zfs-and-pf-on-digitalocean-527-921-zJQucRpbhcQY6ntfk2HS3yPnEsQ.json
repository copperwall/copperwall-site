{"data":{"markdownRemark":{"html":"<h2>Background</h2>\n<p>Jails are a way to create an isolated environment to run programs in on FreeBSD. The idea is that given a directory subtree, hostname, ip address, and start command, you can have an isolated environment to run programs. Programs running within a jail cannot see information about other processes outside of the jail, and cannot open files outside of the directory subtree the jail was started on. I'm currently running nginx on a droplet within a jail. This jail is currently just acting as a web server, but can eventually act as a reverse proxy for other jails.</p>\n<h2>Filesystem Setup with ZFS</h2>\n<p>To setup a jail we need a directory to place the base system. I chose to place my jail directories in <code>/usr/local/jails</code>, but you can place them other places like <code>/usr/jails/</code> or <code>/jails</code>. To start off I created a new ZFS dataset called <code>zroot/jails</code>.</p>\n<p>To create this dataset run:</p>\n<pre><code class=\"language-sh\">zfs create -o mountpoint=/usr/local/jails zroot/jails\n</code></pre>\n<p>We can then create a new dataset named basejail in <code>zroot/jails</code>.</p>\n<pre><code class=\"language-sh\">zfs create zroot/jails/basejail\n</code></pre>\n<p>Now that there's a directory setup for the base jail template, we need to get grab a <a href=\"http://ftp.freebsd.org/pub/FreeBSD/snapshots/amd64/11.0-STABLE/base.txz\">tarred archive</a> of the base system. Once that's extracted we can create a snapshot of the basejail dataset and give it the name of the base system version. My basejail is currently at FreeBSD 11.0-p3, so my base snapshot is called <code>11.0-p3</code>.</p>\n<pre><code class=\"language-sh\"># Extract base sytem to basejail directory\ntar base.txz -C /usr/local/jails/basejail\n\n# Copy resolv.conf\ncp /etc/resolv.conf /usr/local/jails/basejail/etc\n\n# Run freebsd update on the basejail system.\nfreebsd-update -b /usr/local/jails/basejail\n\n# Create a zfs snapshot.\nzfs snapshot zroot/jails/basejail@11.0-p3\n</code></pre>\n<p>You can now clone the snapshot for each new jail you create. If you wanted to create a jail called <code>www</code>, create a new zfs dataset called <code>zroot/jails/www</code> which is cloned from the <code>zroot/jails/basejail@11.0-p3</code> snapshot.</p>\n<pre><code class=\"language-sh\">zfs clone zroot/jails/basejail@11.0-p3 zroot/jails/www\n</code></pre>\n<p>The clone is instant and doesn't take up additional space. Only new changes to the <code>zroot/jails/www</code> will cause extra disc space to be used.</p>\n<h2>Firewall and NAT with PF</h2>\n<p>Jails need an IP address in order to communicate with other machines, but DigitalOcean instances are only given one public IP address, so to get around this we can use PF (Packet Filter) to operate as a NAT and place our jails behind the NAT.</p>\n<p>First off we need a new loopback network interface to communicate over, so we should add the following string to <code>/etc/rc.conf</code>:</p>\n<pre><code class=\"language-conf\"># /etc/rc.conf\n\ncloned_interfaces=\"lo1\"\nifconfig_lo1=\"inet 172.16.1.1 netmask 255.255.255.0\"\n</code></pre>\n<p>This creates a new network interface named <code>lo1</code> which is given an IP address of <code>172.16.1.1</code>. You can give it a different IP address, but make sure that it's one of the <a href=\"https://tools.ietf.org/html/rfc3927\">RFC 3928</a> link-local IP addresses.</p>\n<p>These network settings will have to be loaded after you edit <code>/etc/rc.conf</code>, so you can either restart you machine or run</p>\n<pre><code class=\"language-sh\">/etc/rc.d/netif restart &#x26;&#x26; /etc/rc.d/routing restart\n</code></pre>\n<p>We have an interface and an IP address, but we need firewall rules now to make sure the correct ports are forwarded and that traffic from the jail is allowed through the default interface on the host.</p>\n<p>To do this we add <code>pf_enable=\"YES\"</code> to <code>/etc/rc.conf</code></p>\n<pre><code class=\"language-conf\"># /etc/rc.conf\n\npf_enable=\"YES\"\n</code></pre>\n<p>After that create <code>/etc/pf.conf</code> and add the following information:</p>\n<pre><code class=\"language-conf\"># /etc/pf.conf\n\next_if = \"vtnet0\"\next_addr = \"&#x3C;your public ip address>\"\nint_if = \"lo1\"\njail_net = $int_if:network\n\nnat on $ext_if from $jail_net to any -> $ext_addr port 1024:65535 static-port\n</code></pre>\n<p>Once that's done run <code>service pf start</code> and <code>pfctl -f /etc/pf.conf</code> as root to start <code>pf</code> and to load the new firewall rules.</p>\n<h2>Jail Configuration</h2>\n<p>Jail configuration can be done with <code>sysrc</code> or with <code>/etc/jail.conf</code>. For my purposes I used <code>/etc/jail.conf</code>. My <code>/etc/jail.conf</code> looks like:</p>\n<pre><code class=\"language-conf\"># /etc/jail.conf\n\n# Global Stuff\n\nexec.start =\"/bin/sh /etc/rc\";\nexec.stop = \"/bin/sh /etc/rc.shutdown\";\nexec.clean;\nmount.devfs;\n\npath = \"/usr/local/jails/$name\";\n\n# Jail definition for www.\nwww {\n   host.hostname = \"www.opperwall.net\";\n   ip4.addr = 172.16.1.1;\n}\n</code></pre>\n<p>So far I haven't had to specify anything specific for each individual jail other than <code>host.hostname</code> and <code>ip4.addr</code>.</p>\n<p>To finally start the jail run</p>\n<pre><code class=\"language-sh\">jail -c www\n</code></pre>\n<p>Hooray!</p>\n<p>You can open a shell within the jail using</p>\n<pre><code class=\"language-sh\">jexec www tcsh\n</code></pre>\n<p>By default you cannot use ping or traceroute in a jail because jails do not have permission to use raw sockets. You can test internet connection using something like <code>telnet</code>.</p>\n<h2>Extras</h2>\n<p>Since we made a jail called <code>www</code>, it would be nice if requests to port 80 and 443 on the host machine would get forwarded to the <code>www</code> jail's IP address. This port forwarding can be added with two more lines to the <code>/etc/pf.conf</code> file.</p>\n<p>Add the lines</p>\n<pre><code class=\"language-conf\">www_addr = \"172.16.1.1\"\nwww_web_ports = \"{ 80, 443 }\"\n\nrdr pass on $ext_if inet proto tcp to port $www_web_ports -> $www_addr\n</code></pre>\n<p>Run <code>pfctl -f /etc/pf.conf</code> to load the new rules.</p>\n<h2>References</h2>\n<p><a href=\"http://kbeezie.com/freebsd-jail-single-ip/\">http://kbeezie.com/freebsd-jail-single-ip/</a></p>\n<p><a href=\"https://www.kirkg.us/posts/how-to-configure-a-freebsd-jail-on-a-digital-ocean-droplet/\">https://www.kirkg.us/posts/how-to-configure-a-freebsd-jail-on-a-digital-ocean-droplet/</a></p>","frontmatter":{"title":"Using Jails with ZFS and PF on DigitalOcean"}}},"pageContext":{"slug":"/2016-11-19-jails-with-zfs-and-pf-on-digitalocean/"}}