<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><style data-href="/styles.b06b2600d709496d733b.css">a{text-decoration:none}</style><meta name="generator" content="Gatsby 2.1.4"/><style id="typography.js">html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}body{margin:0}article,aside,details,figcaption,figure,footer,header,main,menu,nav,section,summary{display:block}audio,canvas,progress,video{display:inline-block}audio:not([controls]){display:none;height:0}progress{vertical-align:baseline}[hidden],template{display:none}a{background-color:transparent;-webkit-text-decoration-skip:objects}a:active,a:hover{outline-width:0}abbr[title]{border-bottom:none;text-decoration:underline;text-decoration:underline dotted}b,strong{font-weight:inherit;font-weight:bolder}dfn{font-style:italic}h1{font-size:2em;margin:.67em 0}mark{background-color:#ff0;color:#000}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}img{border-style:none}svg:not(:root){overflow:hidden}code,kbd,pre,samp{font-family:monospace,monospace;font-size:1em}figure{margin:1em 40px}hr{box-sizing:content-box;height:0;overflow:visible}button,input,optgroup,select,textarea{font:inherit;margin:0}optgroup{font-weight:700}button,input{overflow:visible}button,select{text-transform:none}[type=reset],[type=submit],button,html [type=button]{-webkit-appearance:button}[type=button]::-moz-focus-inner,[type=reset]::-moz-focus-inner,[type=submit]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,[type=reset]:-moz-focusring,[type=submit]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal}textarea{overflow:auto}[type=checkbox],[type=radio]{box-sizing:border-box;padding:0}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}[type=search]::-webkit-search-cancel-button,[type=search]::-webkit-search-decoration{-webkit-appearance:none}::-webkit-input-placeholder{color:inherit;opacity:.54}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}html{font:100%/1.625 -apple-system,'BlinkMacSystemFont','Segoe UI','Roboto','Helvetica','Arial',sans-serif,'Apple Color Emoji','Segoe UI Emoji','Segoe UI Symbol';box-sizing:border-box;overflow-y:scroll;}*{box-sizing:inherit;}*:before{box-sizing:inherit;}*:after{box-sizing:inherit;}body{color:hsla(0,0%,0%,0.8);font-family:-apple-system,'BlinkMacSystemFont','Segoe UI','Roboto','Helvetica','Arial',sans-serif,'Apple Color Emoji','Segoe UI Emoji','Segoe UI Symbol';font-weight:normal;word-wrap:break-word;font-kerning:normal;-moz-font-feature-settings:"kern", "liga", "clig", "calt";-ms-font-feature-settings:"kern", "liga", "clig", "calt";-webkit-font-feature-settings:"kern", "liga", "clig", "calt";font-feature-settings:"kern", "liga", "clig", "calt";}img{max-width:100%;margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8125rem;}h1{margin-left:0;margin-right:0;margin-top:2.4375rem;padding-bottom:calc(0.40625rem - 1px);padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.21875rem;color:inherit;font-family:-apple-system,'BlinkMacSystemFont','Segoe UI','Roboto','Helvetica','Arial',sans-serif,'Apple Color Emoji','Segoe UI Emoji','Segoe UI Symbol';font-weight:600;text-rendering:optimizeLegibility;font-size:2rem;line-height:1.1;border-bottom:1px solid hsla(0,0%,0%,0.07);}h2{margin-left:0;margin-right:0;margin-top:1.625rem;padding-bottom:calc(0.40625rem - 1px);padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.40625rem;color:inherit;font-family:-apple-system,'BlinkMacSystemFont','Segoe UI','Roboto','Helvetica','Arial',sans-serif,'Apple Color Emoji','Segoe UI Emoji','Segoe UI Symbol';font-weight:600;text-rendering:optimizeLegibility;font-size:1.51572rem;line-height:1.1;border-bottom:1px solid hsla(0,0%,0%,0.07);}h3{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8125rem;color:inherit;font-family:-apple-system,'BlinkMacSystemFont','Segoe UI','Roboto','Helvetica','Arial',sans-serif,'Apple Color Emoji','Segoe UI Emoji','Segoe UI Symbol';font-weight:600;text-rendering:optimizeLegibility;font-size:1.31951rem;line-height:1.1;}h4{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8125rem;color:inherit;font-family:-apple-system,'BlinkMacSystemFont','Segoe UI','Roboto','Helvetica','Arial',sans-serif,'Apple Color Emoji','Segoe UI Emoji','Segoe UI Symbol';font-weight:600;text-rendering:optimizeLegibility;font-size:1rem;line-height:1.1;}h5{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8125rem;color:inherit;font-family:-apple-system,'BlinkMacSystemFont','Segoe UI','Roboto','Helvetica','Arial',sans-serif,'Apple Color Emoji','Segoe UI Emoji','Segoe UI Symbol';font-weight:600;text-rendering:optimizeLegibility;font-size:0.87055rem;line-height:1.1;}h6{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8125rem;color:hsla(0,0%,0%,0.53);font-family:-apple-system,'BlinkMacSystemFont','Segoe UI','Roboto','Helvetica','Arial',sans-serif,'Apple Color Emoji','Segoe UI Emoji','Segoe UI Symbol';font-weight:600;text-rendering:optimizeLegibility;font-size:0.81225rem;line-height:1.1;}hgroup{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8125rem;}ul{margin-left:1.625rem;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8125rem;list-style-position:outside;list-style-image:none;}ol{margin-left:1.625rem;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8125rem;list-style-position:outside;list-style-image:none;}dl{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8125rem;}dd{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8125rem;}p{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8125rem;}figure{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8125rem;}pre{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8125rem;font-size:0.85rem;line-height:1.625rem;}table{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8125rem;font-size:1rem;line-height:1.625rem;border-collapse:collapse;width:100%;}fieldset{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8125rem;}blockquote{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:calc(0.8125rem - 1px);padding-right:0;padding-top:0;margin-bottom:0.8125rem;border-left:4px solid hsla(0,0%,0%,0.13);color:hsla(0,0%,0%,0.53);}form{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8125rem;}noscript{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8125rem;}iframe{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8125rem;}hr{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:calc(0.8125rem - 1px);background:hsla(0,0%,0%,0.2);border:none;height:1px;}address{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8125rem;}b{font-weight:600;}strong{font-weight:600;}dt{font-weight:600;}th{font-weight:600;}li{margin-bottom:calc(0.8125rem / 2);}ol li{padding-left:0;}ul li{padding-left:0;}li > ol{margin-left:1.625rem;margin-bottom:calc(0.8125rem / 2);margin-top:calc(0.8125rem / 2);}li > ul{margin-left:1.625rem;margin-bottom:calc(0.8125rem / 2);margin-top:calc(0.8125rem / 2);}blockquote *:last-child{margin-bottom:0;}li *:last-child{margin-bottom:0;}p *:last-child{margin-bottom:0;}li > p{margin-bottom:calc(0.8125rem / 2);}code{font-size:0.85rem;line-height:1.625rem;}kbd{font-size:0.85rem;line-height:1.625rem;}samp{font-size:0.85rem;line-height:1.625rem;}abbr{border-bottom:1px dotted hsla(0,0%,0%,0.5);cursor:help;}acronym{border-bottom:1px dotted hsla(0,0%,0%,0.5);cursor:help;}abbr[title]{border-bottom:1px dotted hsla(0,0%,0%,0.5);cursor:help;text-decoration:none;}thead{text-align:left;}td,th{text-align:left;border-bottom:1px solid hsla(0,0%,0%,0.12);font-feature-settings:"tnum";-moz-font-feature-settings:"tnum";-ms-font-feature-settings:"tnum";-webkit-font-feature-settings:"tnum";padding-left:1.08333rem;padding-right:1.08333rem;padding-top:0.8125rem;padding-bottom:calc(0.8125rem - 1px);}th:first-child,td:first-child{padding-left:0;}th:last-child,td:last-child{padding-right:0;}h3,h4,h5,h6{margin-bottom:0.8125rem;margin-top:1.625rem;}ol,ul{margin-left:2.03125rem;}li>ol,li>ul{margin-left:2.03125rem;}a{color:#4078c0;text-decoration:none;}a:hover,a:active{text-decoration:underline;}</style><link as="script" rel="preload" href="/component---src-templates-blog-post-js-55223bcc0ee936eb66f2.js"/><link as="script" rel="preload" href="/0-85912511608260efd9e6.js"/><link as="script" rel="preload" href="/app-122c52d0e65c3530e375.js"/><link as="script" rel="preload" href="/styles-3408986964b82850da36.js"/><link as="script" rel="preload" href="/webpack-runtime-57f31d95c48fe5528c16.js"/><link as="fetch" rel="preload" href="/static/d/935/path---2016-11-19-jails-with-zfs-and-pf-on-digitalocean-527-921-zJQucRpbhcQY6ntfk2HS3yPnEsQ.json" crossorigin="use-credentials"/></head><body><noscript id="gatsby-noscript">This app works best with JavaScript enabled.</noscript><div id="___gatsby"><div style="outline:none" tabindex="-1" role="group"><style data-emotion-css="1gh2tui">.css-1gh2tui{margin:0 auto;max-width:700px;padding:3.25rem;padding-top:2.4375rem;}</style><div class="css-1gh2tui"><a href="/"><style data-emotion-css="9xo11w">.css-9xo11w{margin-bottom:3.25rem;display:inline-block;font-style:normal;}</style><h3 class="css-9xo11w">Copperwall Blog</h3></a><style data-emotion-css="146q31f">.css-146q31f{float:right;}</style><a class="css-146q31f" href="/about/">About</a><div><h1>Using Jails with ZFS and PF on DigitalOcean</h1><div><h2>Background</h2>
<p>Jails are a way to create an isolated environment to run programs in on FreeBSD. The idea is that given a directory subtree, hostname, ip address, and start command, you can have an isolated environment to run programs. Programs running within a jail cannot see information about other processes outside of the jail, and cannot open files outside of the directory subtree the jail was started on. I'm currently running nginx on a droplet within a jail. This jail is currently just acting as a web server, but can eventually act as a reverse proxy for other jails.</p>
<h2>Filesystem Setup with ZFS</h2>
<p>To setup a jail we need a directory to place the base system. I chose to place my jail directories in <code>/usr/local/jails</code>, but you can place them other places like <code>/usr/jails/</code> or <code>/jails</code>. To start off I created a new ZFS dataset called <code>zroot/jails</code>.</p>
<p>To create this dataset run:</p>
<pre><code class="language-sh">zfs create -o mountpoint=/usr/local/jails zroot/jails
</code></pre>
<p>We can then create a new dataset named basejail in <code>zroot/jails</code>.</p>
<pre><code class="language-sh">zfs create zroot/jails/basejail
</code></pre>
<p>Now that there's a directory setup for the base jail template, we need to get grab a <a href="http://ftp.freebsd.org/pub/FreeBSD/snapshots/amd64/11.0-STABLE/base.txz">tarred archive</a> of the base system. Once that's extracted we can create a snapshot of the basejail dataset and give it the name of the base system version. My basejail is currently at FreeBSD 11.0-p3, so my base snapshot is called <code>11.0-p3</code>.</p>
<pre><code class="language-sh"># Extract base sytem to basejail directory
tar base.txz -C /usr/local/jails/basejail

# Copy resolv.conf
cp /etc/resolv.conf /usr/local/jails/basejail/etc

# Run freebsd update on the basejail system.
freebsd-update -b /usr/local/jails/basejail

# Create a zfs snapshot.
zfs snapshot zroot/jails/basejail@11.0-p3
</code></pre>
<p>You can now clone the snapshot for each new jail you create. If you wanted to create a jail called <code>www</code>, create a new zfs dataset called <code>zroot/jails/www</code> which is cloned from the <code>zroot/jails/basejail@11.0-p3</code> snapshot.</p>
<pre><code class="language-sh">zfs clone zroot/jails/basejail@11.0-p3 zroot/jails/www
</code></pre>
<p>The clone is instant and doesn't take up additional space. Only new changes to the <code>zroot/jails/www</code> will cause extra disc space to be used.</p>
<h2>Firewall and NAT with PF</h2>
<p>Jails need an IP address in order to communicate with other machines, but DigitalOcean instances are only given one public IP address, so to get around this we can use PF (Packet Filter) to operate as a NAT and place our jails behind the NAT.</p>
<p>First off we need a new loopback network interface to communicate over, so we should add the following string to <code>/etc/rc.conf</code>:</p>
<pre><code class="language-conf"># /etc/rc.conf

cloned_interfaces="lo1"
ifconfig_lo1="inet 172.16.1.1 netmask 255.255.255.0"
</code></pre>
<p>This creates a new network interface named <code>lo1</code> which is given an IP address of <code>172.16.1.1</code>. You can give it a different IP address, but make sure that it's one of the <a href="https://tools.ietf.org/html/rfc3927">RFC 3928</a> link-local IP addresses.</p>
<p>These network settings will have to be loaded after you edit <code>/etc/rc.conf</code>, so you can either restart you machine or run</p>
<pre><code class="language-sh">/etc/rc.d/netif restart &#x26;&#x26; /etc/rc.d/routing restart
</code></pre>
<p>We have an interface and an IP address, but we need firewall rules now to make sure the correct ports are forwarded and that traffic from the jail is allowed through the default interface on the host.</p>
<p>To do this we add <code>pf_enable="YES"</code> to <code>/etc/rc.conf</code></p>
<pre><code class="language-conf"># /etc/rc.conf

pf_enable="YES"
</code></pre>
<p>After that create <code>/etc/pf.conf</code> and add the following information:</p>
<pre><code class="language-conf"># /etc/pf.conf

ext_if = "vtnet0"
ext_addr = "&#x3C;your public ip address>"
int_if = "lo1"
jail_net = $int_if:network

nat on $ext_if from $jail_net to any -> $ext_addr port 1024:65535 static-port
</code></pre>
<p>Once that's done run <code>service pf start</code> and <code>pfctl -f /etc/pf.conf</code> as root to start <code>pf</code> and to load the new firewall rules.</p>
<h2>Jail Configuration</h2>
<p>Jail configuration can be done with <code>sysrc</code> or with <code>/etc/jail.conf</code>. For my purposes I used <code>/etc/jail.conf</code>. My <code>/etc/jail.conf</code> looks like:</p>
<pre><code class="language-conf"># /etc/jail.conf

# Global Stuff

exec.start ="/bin/sh /etc/rc";
exec.stop = "/bin/sh /etc/rc.shutdown";
exec.clean;
mount.devfs;

path = "/usr/local/jails/$name";

# Jail definition for www.
www {
   host.hostname = "www.opperwall.net";
   ip4.addr = 172.16.1.1;
}
</code></pre>
<p>So far I haven't had to specify anything specific for each individual jail other than <code>host.hostname</code> and <code>ip4.addr</code>.</p>
<p>To finally start the jail run</p>
<pre><code class="language-sh">jail -c www
</code></pre>
<p>Hooray!</p>
<p>You can open a shell within the jail using</p>
<pre><code class="language-sh">jexec www tcsh
</code></pre>
<p>By default you cannot use ping or traceroute in a jail because jails do not have permission to use raw sockets. You can test internet connection using something like <code>telnet</code>.</p>
<h2>Extras</h2>
<p>Since we made a jail called <code>www</code>, it would be nice if requests to port 80 and 443 on the host machine would get forwarded to the <code>www</code> jail's IP address. This port forwarding can be added with two more lines to the <code>/etc/pf.conf</code> file.</p>
<p>Add the lines</p>
<pre><code class="language-conf">www_addr = "172.16.1.1"
www_web_ports = "{ 80, 443 }"

rdr pass on $ext_if inet proto tcp to port $www_web_ports -> $www_addr
</code></pre>
<p>Run <code>pfctl -f /etc/pf.conf</code> to load the new rules.</p>
<h2>References</h2>
<p><a href="http://kbeezie.com/freebsd-jail-single-ip/">http://kbeezie.com/freebsd-jail-single-ip/</a></p>
<p><a href="https://www.kirkg.us/posts/how-to-configure-a-freebsd-jail-on-a-digital-ocean-droplet/">https://www.kirkg.us/posts/how-to-configure-a-freebsd-jail-on-a-digital-ocean-droplet/</a></p></div></div><a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-sa/4.0/88x31.png"/></a></div></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.page={"componentChunkName":"component---src-templates-blog-post-js","jsonName":"2016-11-19-jails-with-zfs-and-pf-on-digitalocean-527","path":"/2016-11-19-jails-with-zfs-and-pf-on-digitalocean/"};window.dataPath="935/path---2016-11-19-jails-with-zfs-and-pf-on-digitalocean-527-921-zJQucRpbhcQY6ntfk2HS3yPnEsQ";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"app":["/app-122c52d0e65c3530e375.js"],"component---src-templates-blog-post-js":["/component---src-templates-blog-post-js-55223bcc0ee936eb66f2.js"],"component---src-pages-about-js":["/component---src-pages-about-js-95a78d56f5c264bba832.js"],"component---src-pages-index-js":["/component---src-pages-index-js-da2faa332dbec3f2603f.js"],"pages-manifest":["/pages-manifest-5a4bb7182421bb6c33c2.js"]};/*]]>*/</script><script src="/webpack-runtime-57f31d95c48fe5528c16.js" async=""></script><script src="/styles-3408986964b82850da36.js" async=""></script><script src="/app-122c52d0e65c3530e375.js" async=""></script><script src="/0-85912511608260efd9e6.js" async=""></script><script src="/component---src-templates-blog-post-js-55223bcc0ee936eb66f2.js" async=""></script></body></html>